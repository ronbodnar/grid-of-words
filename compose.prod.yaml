services:
#  fix-permissions:
#    image: alpine
 #   command: >
#      sh -c "chown -R node:node /etc/letsencrypt && chmod -R 644 /etc/letsencrypt
 #   volumes:
 #     - certbot_etc:/etc/letsencrypt
 ##   entrypoint: []
  #  deploy:
  #    replicas: 1 # Ensures it runs only once

  # The main application (API services and front-end JavaScript)
  grid-of-words-app:
    container_name: grid-of-words-app
    build:
      context: .
      target: prod
      dockerfile: Dockerfile

    env_file: "production.env"

    ports:
      - 3000:3000

    depends_on:
      grid-of-words-db:
        condition: service_healthy

    restart: always

    volumes:
      - certbot_etc:/etc/letsencrypt

    networks:
      - backend

  # The mongo database service
  grid-of-words-db:
    container_name: grid-of-words-db
    image: mongo:6.0.18-rc0-jammy

    ports:
      - 27017:27017
      
    healthcheck:
      test:
        ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 1m
      timeout: 15s
      retries: 2
      start_period: 10s

    restart: always

    env_file: "production.env"

    volumes:
      - ./scripts/populate-db.sh:/docker-entrypoint-initdb.d/populate-db.sh
      - ./data/words_english.txt:/data/words_english.txt
      - ./data/words_spanish.txt:/data/words_spanish.txt
      - grid-of-words-data:/data/db/

    networks:
      - backend

volumes:
  grid-of-words-data:
    name: "grid-of-words-data"
  certbot_etc:
    name: "certbot_etc"
    external: true

# Uses the default home network (must be created first).
networks:
  backend:
    external: true


